<!DOCTYPE html>
<html lang = "en">
    <head>
        <link rel="stylesheet" href="../css/form-home.css">
        <script>
            
        </script>      
    </head>
    <body>
        <div class="calender">
          <div class="header">
            <button class="prevBtn" onclick="prevCal()"></button>
            <div class="title">
              <div class="yearTitle"></div>
              <div>년 </div>
              <div class="monthTitle"></div>
              <div>월</div>
            </div>
            <button class="nextBtn" onclick="nextCal()"></button>
          </div>
          <div class="main">
            <div class="daies">
              <div class="day">Sun</div>
              <div class="day">Mon</div>
              <div class="day">Tue</div>
              <div class="day">Wed</div>
              <div class="day">Thu</div>
              <div class="day">Fri</div>
              <div class="day">Sat</div>
            </div>
            <div class="dates"></div>
          </div>
        </div>
        <script>
            let CDate = new Date();
            let today = new Date();
            var holiday = []; 

            buildCalender();
            alert("3번째"+holiday[0]);

            function dataCalender(m_year, m_month){
                holiday = [];

                if(Number(m_month) < 10){
                    m_month = '0' + m_month;
                }

                var xhr = new XMLHttpRequest();
                var url = 'http://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo'; /*URL*/
                var queryParams = '?' + encodeURIComponent('serviceKey') + '='+'9w2R3ZT8bsi3XMGwmm9tHlU1t27lPUZYjDLFHKi700HokF%2FCnB4w5mDKIAAB%2BmofzatSUls54oYcNcRLD11aww%3D%3D'; /*Service Key*/
                queryParams += '&' + encodeURIComponent('solYear') + '=' + encodeURIComponent(m_year); /**/
                queryParams += '&' + encodeURIComponent('solMonth') + '=' + encodeURIComponent(m_month); /**/
                //alert(url + queryParams);
                xhr.open('GET', url + queryParams);
                alert("open 실행");

                xhr.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        alert("if문 실행");
                        //alert('nBody: '+this.responseText);
                        let index = 0;
                        let str = this.responseText

                        while(str.indexOf('<locdate>', index) != -1){
                            index = str.indexOf('<locdate>', index) + 9;
                            let date = str.substr(index, 8); 
                            //alert(date);
                            //alert(Number(date.substr(6, 2)));
                            let price = Number(date.substr(6, 2));
                            holiday.push(price);
                            // for (let index = 0; index < holiday.length; index++) {
                            //     alert('holiday['+ index + '] = ' + holiday[index]);
                            // }
                        }
                        alert("1번째"+holiday[0]);
                    }
                };
                alert("onreadystatechange 실행");
                alert("2번째"+holiday[0]);

                xhr.send('');
                alert("send 실행");
            }

            function buildCalender(){
                let size_pre = 0;
                let size_next = 0;
                let prevLast = new Date(CDate.getFullYear(), CDate.getMonth(), 0);
                let thisFirst = new Date(CDate.getFullYear(), CDate.getMonth(), 1);
                let thisLast = new Date(CDate.getFullYear(), CDate.getMonth() + 1, 0);
                document.querySelector(".yearTitle").innerHTML = CDate.getFullYear();
                document.querySelector(".monthTitle").innerHTML = CDate.getMonth() + 1;
                let dates = [];

                dataCalender(String(CDate.getFullYear()), String(CDate.getMonth() + 1));

                if(thisFirst.getDay()!=0){
                    size_pre = thisFirst.getDay();
                    for(let i = 0; i < thisFirst.getDay(); i++){
                        dates.unshift(prevLast.getDate()-i);
                    }
                }

                for(let i = 1; i <= thisLast.getDate(); i++){
                    dates.push(i);
                }

                for(let i = 1; i <= 13 - thisLast.getDay(); i++){
                    dates.push(i);
                }

                for(let i = 0; i < 42; i++){
                    if(dates[i-1] > dates[i]){
                        size_next = i;
                    }
                }

                let htmlDates = '';
                for(let i = 0; i < 42; i++){
                    if(today.getDate()==dates[i] && today.getMonth()==CDate.getMonth() && today.getFullYear()==CDate.getFullYear()){
                        htmlDates += `<div class="date today">${dates[i]}</div>`;
                    }
                    else if(i < size_pre || size_next <= i){
                        htmlDates += `<div class="date cloud">${dates[i]}</div>`;
                    }
                    else{
                        htmlDates += `<div class="date">${dates[i]}</div>`;
                    }
                }
                
                document.querySelector(".dates").innerHTML = htmlDates;
            }

            function prevCal(){
                CDate.setDate(1)
                CDate.setMonth(CDate.getMonth()-1);
                buildCalender();
            }

            function nextCal(){
                CDate.setDate(1)
                CDate.setMonth(CDate.getMonth()+1);
                buildCalender();
            }
        </script>
      </body>
</html>